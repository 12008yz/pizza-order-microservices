# Задача: Переделка микросервисного приложения

## Описание проекта

**Исходное приложение:** Микросервисное приложение для заказа пиццы
**Целевое приложение:** Агрегатор интернет-провайдеров и тарифов (по типу 101интернет, Тарифник)



---

## Общая концепция нового приложения

Сайт-агрегатор, где пользователи могут:
- Проверить доступность интернет-провайдеров по своему адресу
- Сравнить тарифы по цене, скорости, дополнительным услугам
- Оставить заявку на подключение к выбранному провайдеру
- Читать отзывы о провайдерах

---

## Чеклист изменений

### 1. Docker Compose (`docker-compose.yml`)

- [ ] Переименовать контейнеры баз данных:
  - `pizza-auth-db` → `tariff-auth-db`
  - `pizza-user-db` → `tariff-user-db`
  - `pizza-product-db` → `tariff-provider-db`
  - `pizza-order-db` → `tariff-application-db`

- [ ] Переименовать контейнеры сервисов:
  - `pizza-auth-service` → `tariff-auth-service`
  - `pizza-user-service` → `tariff-user-service`
  - `pizza-product-service` → `tariff-provider-service`
  - `pizza-order-service` → `tariff-application-service`
  - `pizza-frontend` → `tariff-frontend`

- [ ] Переименовать сеть:
  - `pizza-network` → `tariff-network`

- [ ] Переименовать volumes:
  - `product_db_data` → `provider_db_data`
  - `order_db_data` → `application_db_data`

- [ ] Обновить переменные окружения (URL сервисов)

---

### 2. Product Service → Provider Service

**Путь:** `services/product-service` → `services/provider-service`

#### 2.1 Модель Product → Tariff (`src/models/Tariff.ts`)

**Удалить поля:**
```
- category: 'pizza' | 'drink' | 'side'
- imageUrl
```

**Новые поля:**
```typescript
interface TariffAttributes {
  id: number;
  name: string;                    // "Домашний интернет 100"
  description: string;             // Описание тарифа
  providerId: number;              // FK на Provider

  // Интернет
  speed: number;                   // Скорость Мбит/с
  price: number;                   // Ежемесячная плата
  connectionPrice: number;         // Стоимость подключения (0 = бесплатно)
  technology: 'fiber' | 'dsl' | 'cable' | 'wireless' | 'mobile';

  // ТВ
  hasTV: boolean;
  tvChannels: number | null;       // Количество каналов

  // Мобильная связь (пакет)
  hasMobile: boolean;
  mobileMinutes: number | null;    // Минуты
  mobileGB: number | null;         // Гигабайты
  mobileSMS: number | null;        // SMS

  // Акции
  promoPrice: number | null;       // Акционная цена
  promoMonths: number | null;      // На сколько месяцев

  // Статус
  isActive: boolean;

  createdAt: Date;
  updatedAt: Date;
}
```

#### 2.2 Новая модель Provider (`src/models/Provider.ts`)

```typescript
interface ProviderAttributes {
  id: number;
  name: string;                    // "Ростелеком"
  slug: string;                    // "rostelecom"
  logo: string;                    // URL логотипа
  description: string;             // Описание компании
  website: string;                 // Официальный сайт
  phone: string;                   // Телефон поддержки

  // Рейтинг
  rating: number;                  // Средний рейтинг (1-5)
  reviewsCount: number;            // Количество отзывов

  // Мета
  foundedYear: number | null;      // Год основания
  isActive: boolean;

  createdAt: Date;
  updatedAt: Date;
}
```

#### 2.3 Новая модель Coverage (`src/models/Coverage.ts`)

```typescript
interface CoverageAttributes {
  id: number;
  providerId: number;              // FK на Provider
  city: string;                    // "Москва"
  district: string | null;         // "Центральный"
  street: string | null;           // "Тверская"
  houseFrom: number | null;        // Номер дома с
  houseTo: number | null;          // Номер дома по

  createdAt: Date;
  updatedAt: Date;
}
```

#### 2.4 Контроллеры

- [ ] `product.controller.ts` → `tariff.controller.ts`
  - Добавить фильтрацию по: скорости, цене, провайдеру, технологии, наличию ТВ
  - Добавить сортировку по: цене, скорости, рейтингу провайдера
  - Добавить поиск по адресу

- [ ] Создать `provider.controller.ts`
  - CRUD для провайдеров
  - Получение тарифов провайдера
  - Получение зон покрытия

- [ ] Создать `coverage.controller.ts`
  - Проверка доступности по адресу
  - Получение списка провайдеров по адресу

#### 2.5 Роуты

- [ ] `product.routes.ts` → `tariff.routes.ts`
  - `GET /tariffs` — список с фильтрами
  - `GET /tariffs/:id` — детали тарифа
  - `GET /tariffs/by-address` — тарифы по адресу
  - `POST /tariffs` — создание (admin)
  - `PUT /tariffs/:id` — обновление (admin)
  - `DELETE /tariffs/:id` — удаление (admin)

- [ ] Создать `provider.routes.ts`
  - `GET /providers` — список провайдеров
  - `GET /providers/:id` — детали провайдера
  - `GET /providers/:id/tariffs` — тарифы провайдера
  - `POST /providers` — создание (admin)
  - `PUT /providers/:id` — обновление (admin)

- [ ] Создать `coverage.routes.ts`
  - `GET /coverage/check` — проверка адреса
  - `GET /coverage/cities` — список городов
  - `GET /coverage/streets` — улицы в городе

#### 2.6 Миграции

- [ ] Удалить `20240101000000-create-products.js`
- [ ] Создать `20240101000000-create-providers.js`
- [ ] Создать `20240101000001-create-tariffs.js`
- [ ] Создать `20240101000002-create-coverage.js`

#### 2.7 Сидеры

- [ ] Удалить `20240101000000-demo-products.ts`
- [ ] Создать `20240101000000-demo-providers.ts`
- [ ] Создать `20240101000001-demo-tariffs.ts`
- [ ] Создать `20240101000002-demo-coverage.ts`

**Примеры данных для провайдеров:**
```
- Ростелеком
- МТС
- Билайн
- Мегафон
- Дом.ру
- ТТК
- Акадо
- NetByNet
```

**Примеры тарифов:**
```
- Домашний интернет 100 (100 Мбит/с, 500₽/мес)
- Домашний интернет 300 (300 Мбит/с, 700₽/мес)
- Интернет + ТВ (100 Мбит/с + 150 каналов, 800₽/мес)
- Всё в одном (интернет + ТВ + мобильная связь)
```

---

### 3. Order Service → Application Service

**Путь:** `services/order-service` → `services/application-service`

#### 3.1 Модель Order → Application (`src/models/Application.ts`)

**Удалить поля:**
```
- totalAmount
- deliveryAddress (заменить на структурированный адрес)
```

**Новая структура:**
```typescript
interface ApplicationAttributes {
  id: number;

  // Связи
  userId: number | null;           // Null для неавторизованных
  tariffId: number;                // Выбранный тариф
  providerId: number;              // Провайдер (денормализация)

  // Статус заявки
  status: 'new' | 'processing' | 'contacted' | 'scheduled' | 'connected' | 'cancelled' | 'rejected';

  // Контактные данные
  fullName: string;                // ФИО
  phone: string;                   // Телефон (обязательно)
  email: string | null;            // Email

  // Адрес подключения
  city: string;
  street: string;
  house: string;
  building: string | null;         // Корпус/строение
  apartment: string | null;        // Квартира
  entrance: string | null;         // Подъезд
  floor: string | null;            // Этаж
  intercom: string | null;         // Домофон

  // Предпочтения
  preferredDate: Date | null;      // Желаемая дата
  preferredTimeFrom: string | null; // Время с
  preferredTimeTo: string | null;   // Время по
  comment: string | null;          // Комментарий

  // Аналитика (UTM-метки)
  source: string | null;           // Источник
  utmSource: string | null;
  utmMedium: string | null;
  utmCampaign: string | null;
  utmContent: string | null;
  utmTerm: string | null;

  // Служебное
  assignedTo: string | null;       // Менеджер
  internalComment: string | null;  // Внутренний комментарий

  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.2 Удалить модель OrderItem

- [ ] Удалить `src/models/OrderItem.ts`
- [ ] Удалить `src/models/index.ts` (или обновить)
- [ ] Удалить миграцию `20240101000001-create-order-items.js`

Заявка = 1 тариф. Корзина не нужна.

#### 3.3 Контроллер

- [ ] `order.controller.ts` → `application.controller.ts`
  - Убрать логику корзины и items
  - Добавить создание заявки с полными данными
  - Добавить обновление статуса
  - Добавить фильтрацию по статусу, дате, провайдеру
  - Добавить назначение менеджера

#### 3.4 Роуты

- [ ] `order.routes.ts` → `application.routes.ts`
  - `POST /applications` — создание заявки (без авторизации!)
  - `GET /applications` — список заявок (admin)
  - `GET /applications/my` — мои заявки (авторизованный пользователь)
  - `GET /applications/:id` — детали заявки
  - `PUT /applications/:id/status` — обновление статуса (admin)
  - `PUT /applications/:id/assign` — назначение менеджера (admin)

#### 3.5 Миграции

- [ ] Удалить `20240101000000-create-orders.js`
- [ ] Удалить `20240101000001-create-order-items.js`
- [ ] Создать `20240101000000-create-applications.js`

---

### 4. User Service

**Путь:** `services/user-service`

#### 4.1 Модель UserProfile — дополнения

**Добавить поля:**
```typescript
// Расширить существующую модель
street: string | null;
house: string | null;
building: string | null;
apartment: string | null;

// Текущий провайдер (опционально)
currentProviderId: number | null;
currentTariffName: string | null;

// Сохранённые адреса (JSON)
savedAddresses: JSON | null;
```

#### 4.2 Миграция

- [ ] Создать миграцию для добавления новых полей

---

### 5. Auth Service

**Путь:** `services/auth-service`

Изменения минимальные, сервис остаётся практически без изменений.

- [ ] Обновить комментарии и названия (убрать упоминания pizza)

---

### 6. Frontend

**Путь:** `frontend`

#### 6.1 Главная страница (`src/app/page.tsx`)

**Полная переделка интерфейса:**

- [ ] Убрать:
  - Меню пиццы
  - Корзину
  - Кнопки "Добавить в корзину"
  - "Оформить заказ"

- [ ] Добавить:
  - Hero-секция с формой проверки адреса
  - Поле выбора города
  - Поле ввода улицы (с автокомплитом)
  - Поле ввода дома
  - Кнопка "Проверить"

#### 6.2 Новые страницы

- [ ] `/tariffs` — Список тарифов
  - Фильтры: скорость, цена, провайдер, ТВ, тип подключения
  - Сортировка: по цене, по скорости, по рейтингу
  - Карточки тарифов

- [ ] `/tariff/[id]` — Детальная страница тарифа
  - Полное описание
  - Характеристики
  - Кнопка "Подключить"
  - Другие тарифы провайдера

- [ ] `/providers` — Список провайдеров
  - Карточки провайдеров
  - Рейтинг, количество отзывов
  - Количество тарифов

- [ ] `/provider/[id]` — Страница провайдера
  - Информация о компании
  - Список тарифов
  - Отзывы
  - Зоны покрытия

- [ ] `/application` — Форма заявки
  - ФИО
  - Телефон
  - Email
  - Адрес (город, улица, дом, квартира)
  - Выбранный тариф (из URL параметра)
  - Желаемая дата/время
  - Комментарий

- [ ] `/my-applications` — Мои заявки (для авторизованных)
  - Список заявок со статусами
  - Детали заявки

- [ ] `/compare` — Сравнение тарифов
  - Таблица сравнения выбранных тарифов

#### 6.3 Компоненты

- [ ] `TariffCard` — карточка тарифа
- [ ] `ProviderCard` — карточка провайдера
- [ ] `AddressForm` — форма ввода адреса
- [ ] `ApplicationForm` — форма заявки
- [ ] `TariffFilters` — фильтры тарифов
- [ ] `CompareTable` — таблица сравнения
- [ ] `RatingStars` — звёзды рейтинга

#### 6.4 API Routes

- [ ] `/api/auth/[...path]` — оставить
- [ ] `/api/products/route.ts` → `/api/tariffs/route.ts`
- [ ] `/api/orders/route.ts` → `/api/applications/route.ts`
- [ ] Добавить `/api/providers/route.ts`
- [ ] Добавить `/api/coverage/route.ts`

#### 6.5 Стили и тексты

- [ ] Обновить `globals.css` под новый дизайн
- [ ] Обновить `layout.tsx` — заголовок, мета-теги
- [ ] Все тексты "Pizza" заменить на "Тарифы" / "Интернет-провайдеры"

---

### 7. Package.json файлы

- [ ] Корневой `package.json` — обновить name и description
- [ ] `frontend/package.json` — обновить name
- [ ] `services/*/package.json` — обновить names

---

### 8. Документация

- [ ] Обновить `README.md`
- [ ] Обновить `GETTING_STARTED.md`
- [ ] Обновить `QUICK_START.md`
- [ ] Удалить или обновить тестовые скрипты (`test-app.ps1`, `check-registration.ps1`)

---

## Порядок выполнения работ

1. **Docker и инфраструктура** — переименование
2. **Provider Service** — модели, миграции, контроллеры
3. **Application Service** — модели, миграции, контроллеры
4. **User Service** — дополнения
5. **Frontend** — новый интерфейс
6. **Тестирование**
7. **Документация**

---

## Примечания

- Все изменения должны быть обратно совместимы с Docker
- Миграции должны быть в правильном порядке (сначала providers, потом tariffs)
- Frontend может работать без авторизации для просмотра тарифов
- Заявки можно оставлять без регистрации
